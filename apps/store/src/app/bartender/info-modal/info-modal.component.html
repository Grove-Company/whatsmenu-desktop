<div
  *ngIf="data.item.image && previewMode"
  [@startPreview]
  (click)="previewMode = false"
  style="display: flex; align-items: center; justify-content: center; height: 100%; transition: all 1s; border-radius: 6px"
>
  <img src="{{ itemImage }}" alt="{{ itemName }}" style="max-width: 100vw; max-height: 75vh" />
</div>
<ng-container *ngIf="!previewMode" class="d-flex flex-column justify-content-between h-100">
  <header mat-card-header class="p-3">
    <div [ngSwitch]="data.type" class="d-flex flex-column w-100">
      <div class="d-flex align-items-center">
        <fa-icon [icon]="faArrowLeft" (click)="clear()" class="pe-4" style="font-size: 1.25rem; font-weight: bold; cursor: pointer"></fa-icon>
        <img *ngIf="itemImage" (click)="previewMode = true" src="{{ itemImage }}" alt="{{ itemName }}" />
        <div class="d-flex flex-column flex-justify-start ms-4" style="align-self: flex-start">
          <h2>{{ itemName }}</h2>
          <p style="max-height: 85px; overflow-y: auto">{{ data.item.description }}</p>
        </div>
      </div>
      <!-- <div *ngSwitchCase="'default'">
        <div class="element-detail no-scroll-bar flex-column">
          <div class="d-flex align-items-center my-4">
            <h3 class="m-0">Quantidade</h3>
            <div class="d-flex align-items-center ps-2 h-100">
              <fa-icon [icon]="faMinusCircle" [ngStyle]="{ opacity: product.quantity > 1 ? 1 : 0 }"
                (click)="cartService.decreaseProduct(product);$event.stopPropagation()"
                style="color: var(--red); font-size: 1.25rem; cursor: pointer;">
              </fa-icon>
              <span class="mx-2" style="font-weight: bold;">{{ product.quantity }}</span>
              <fa-icon [icon]="faPlusCircle" (click)="cartService.increaseProduct(product); $event.stopPropagation()"
                style="color: var(--green); font-size: 1.25rem; cursor: pointer;">
              </fa-icon>
            </div>
          </div>

        </div>
      </div>
      <div *ngSwitchCase="'pizza'">
        <div class="element-detail flex-column no-scroll-bar">
          <div class="d-flex align-items-center my-4">
            <h3 class="m-0">Quantidade</h3>
            <div class="d-flex align-items-center ps-2">
              <fa-icon style="color: var(--red); font-size: 1.25rem; cursor: pointer;" [icon]="faMinusCircle"
                [ngStyle]="{ opacity: pizza.quantity > 1 ? 1 : 0 }"
                (click)="cartService.decreasePizza(pizza);$event.stopPropagation()">
              </fa-icon>
              <span class="mx-2" style="font-weight: bold;">{{ pizza.quantity }}</span>
              <fa-icon style="color: var(--green); font-size: 1.25rem; cursor: pointer;" [icon]="faPlusCircle"
                (click)="cartService.increasePizza(pizza); $event.stopPropagation()">
              </fa-icon>
            </div>
          </div>
        </div>
      </div> -->
    </div>
  </header>
  <mat-dialog-content [ngStyle]="{ overflow: flavorsDropdown?.isOpen() ? 'visible' : 'auto' }">
    <div [ngSwitch]="data.type" class="px-3">
      <div *ngSwitchCase="'default'" class="h-100">
        <div>
          <pdv-complements
            [(complements)]="product.complements"
            [originalComplements]="product.originalComplements"
            [(cart)]="cart"
          ></pdv-complements>
        </div>
      </div>
      <div *ngSwitchCase="'pizza'">
        <!-- <div class="my-2">
          <h4 class="mb-3">Bordas e Massas</h4>
          <ul style="display: flex; flex-direction: column; gap: 10px;">
            <li class="d-flex">
              <span style="flex-grow: 1;">
                <input type="radio" class="form-check-input me-2" name="radio_basic" [value]="'none'" [id]="'none'"
                  (click)="pizza.implementations = []">
                <label for="none">Nenhum</label>
              </span>
            </li>
            <div style="display: flex; flex-direction: column; gap: 10px;">
              <li class="d-flex"
                *ngFor="let implementation of pizzaProduct.implementations; index as index; trackBy: trackBy">
                <span style="flex-grow: 1;">
                  <input type="radio" class="form-check-input me-2" name="radio_basic" [value]="implementation"
                    [id]="index" (click)="pizza.implementations = [implementation]">
                  <label [for]="index">{{ implementation.name }}</label>
                </span>
                <span class="me-4 text-bold">+ {{ implementation.value  | currency }}</span>
              </li>

            </div>
          </ul>
        </div> -->
        <div class="d-flex flex-column flex-md-row gap-3">
          <div ngbDropdown class="d-flex align-items-center gap-2 cursor-pointer w-50" [autoClose]="true">
            <span class="fw-bold">Tamanho</span>
            <div class="d-flex align-items-center gap-2 border rounded py-1 px-2" id="dropdownBasic1" ngbDropdownToggle>
              {{ cartService.getSizeByCode(pizza).name }} - {{ cartService.pizzaTotalValue(pizza, 'D') * pizza.quantity | currency }}
            </div>
            <div ngbDropdownMenu class="w-100" aria-labelledby="dropdownBasic1">
              <div class="d-flex flex-column">
                <ng-container *ngFor="let size of pizza.sizes; index as index; trackBy: trackBy">
                  <button ngbDropdownItem class="p-1" (click)="pizza.sizeCode = size.code">
                    <!-- *ngIf="cartService.sizeIsAllowed(size, pizza)"  -->
                    {{ size.name }} - {{ cartService.pizzaTotalValue(pizza, 'D') * pizza.quantity | currency }}
                  </button>
                </ng-container>
              </div>
            </div>
          </div>
          <div
            ngbDropdown
            class="d-flex align-items-center gap-2 cursor-pointer w-50"
            [autoClose]="true"
            *ngIf="!context.profile.options.pizza.multipleBorders"
          >
            <span class="fw-bold">Borda</span>
            <div class="d-flex align-items-center justify-content-between gap-2 border rounded py-1 px-2" id="dropdownBasic1" ngbDropdownToggle>
              {{ pizza.implementations?.length ? pizza.implementations[0].name : 'Nenhum' }}
            </div>
            <div ngbDropdownMenu class="w-100" aria-labelledby="dropdownBasic1">
              <div class="d-flex flex-column" style="max-height: 10rem; overflow-y: auto">
                <button ngbDropdownItem class="p-1" (click)="pizza.implementations = []">
                  <!-- *ngIf="cartService.sizeIsAllowed(size, pizza)"  -->
                  Nenhum
                </button>
                <ng-container *ngFor="let implementation of pizzaProduct.implementations">
                  <button ngbDropdownItem class="p-1" (click)="pizza.implementations = [implementation]">
                    <!-- *ngIf="cartService.sizeIsAllowed(size, pizza)"  -->
                    {{ implementation.name }}
                  </button>
                </ng-container>
              </div>
            </div>
          </div>
        </div>
        <!-- <ul style="display: flex; flex-direction: column; gap: 10px;">
          <li *ngFor="let newFlavor of pizza.flavors; index as index; trackBy: trackBy; let label = 'Sabor'">
            <div style="display: flex; align-items: center; justify-content: space-between;">
              <label for="">Sabor {{index + 1}}</label>
              <div *ngIf="index === 0" class="p-2" style="flex-basis: 33.4%;">{{ newFlavor.name }}</div>
              <div *ngIf="index !== 0" ngbDropdown style="flex-basis: 33.4%; cursor: pointer;" [autoClose]="true">
                <div class="d-flex align-items-center justify-content-between p-2 w-100" id="dropdownBasic1"
                  ngbDropdownToggle>
                  {{ newFlavor.name }}
                </div>
                <div ngbDropdownMenu class="w-100" aria-labelledby="dropdownBasic1">
                  <div class=" d-flex flex-column" style="max-height: 10rem; overflow-y: auto;">
                    <ng-container *ngFor="let flavor of pizzaProduct.flavors;">
                      <button ngbDropdownItem class="p-1" (click)="pizza.flavors[index] = flavor">
                        {{ flavor.name }}
                      </button>
                    </ng-container>
                  </div>
                </div>
              </div>
              <fa-icon [ngStyle]="{ opacity: index !== 0 ? 1 : 0, cursor: index !== 0 ? 'pointer' : ''  }"
                [icon]="faTimesCircle" style="color: var(--red); font-size: 1.25rem;"
                (click)="cartService.removeFlavor(pizza, index)">
              </fa-icon>
            </div>
            <div class="d-flex flex-column">
              <div *ngIf="!uniqueImplementation" ngbDropdown [autoClose]="true"
                class="d-flex align-items-center gap-2 cursor-pointer">
                <span class="fw-bold">Borda</span>
                <div class="d-flex align-items-center justify-content-between p-2 w-100" id="dropdownBasic1"
                  ngbDropdownToggle>
                  {{ newFlavor.implementations?.length ? newFlavor.implementations[0].name : "Nenhum" }}
                </div>
                <div ngbDropdownMenu class="w-100" aria-labelledby="dropdownBasic1">
                  <div class=" d-flex flex-column" style="max-height: 10rem; overflow-y: auto;">
                    <button ngbDropdownItem class="p-1" (click)="newFlavor.implementations = []">
                      Nenhum
                    </button>
                    <ng-container *ngFor="let implementation of pizzaProduct.implementations;">
                      <button ngbDropdownItem class="p-1" (click)="newFlavor.implementations = [implementation]">
                        {{ implementation.name }}
                      </button>
                    </ng-container>
                  </div>
                </div>
              </div>
              <button class="d-flex btn btn-link text-decoration-none" (click)="openFlavorComponents(newFlavor)">+ {{
                newFlavor.complements.length ? "Editar" : "Adicionar" }} Complementos</button>
            </div>
          </li>
        </ul> -->
        <div>
          <nav
            ngbNav
            #nav="ngbNav"
            [destroyOnHide]="false"
            class="nav nav-tabs mt-3 d-flex flex-column flex-md-row"
            role="tablist"
            [activeId]="flavorTabActive"
          >
            <ng-container *ngFor="let newFlavor of pizza.flavors; index as index; trackBy: trackBy; let label = Sabor">
              <div [ngbNavItem]="index" class="position-relative">
                <!-- [ngStyle]="{ 'background-color': viewContentAlternate === 'delivery' ?  context.Luminosity(clientData.color).background : '', color : viewContentAlternate === 'delivery' ? context.Luminosity(clientData.color).color : ''}" -->
                <span
                  *ngIf="index + 1 === pizza.flavors.length"
                  [ngStyle]="{ opacity: index !== 0 ? 1 : 0, cursor: index !== 0 ? 'pointer' : '' }"
                  class="position-absolute top-0 start-100 translate-middle badge bg-white p-0 rounded-circle"
                  style="z-index: 99999"
                >
                  <fa-icon [icon]="faTimesCircle" style="color: var(--red); font-size: 1.25rem" (click)="removeFlavor(index)"> </fa-icon>
                </span>
                <a ngbNavLink href="#">Sabor {{ index + 1 }} </a>
                <ng-template ngbNavContent>
                  <div class="p-2 border border-top-0">
                    <div class="d-flex">
                      <div class="d-flex align-items-center gap-3 flex-grow-1">
                        <label for="" class="fw-bold">Sabor {{ index + 1 }}</label>
                        <!-- <div *ngIf="index === 0" class="p-2" style="flex-basis: 33.4%;">{{ newFlavor.name }}</div> -->
                        <div ngbDropdown #flavorsDropdown="ngbDropdown" class="cursor-pointer border rounded py-1 px-2" [autoClose]="true">
                          <div class="d-flex align-items-center gap-2" id="dropdownBasic1" ngbDropdownToggle>
                            {{ newFlavor.name }}
                          </div>
                          <div ngbDropdownMenu class="w-100" aria-labelledby="dropdownBasic1" style="z-index: 999">
                            <div class="d-flex flex-column" style="max-height: 10rem; overflow-y: auto">
                              <ng-container *ngFor="let flavor of pizzaProduct.flavors">
                                <button ngbDropdownItem class="p-1" (click)="pizza.flavors[index] = flavor">
                                  <!-- *ngIf="cartService.sizeIsAllowed(size, pizza)"  -->
                                  {{ flavor.name }}
                                </button>
                              </ng-container>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div
                        *ngIf="context.profile.options.pizza.multipleBorders"
                        ngbDropdown
                        [autoClose]="true"
                        class="d-flex align-items-center gap-3 cursor-pointer flex-grow-1"
                      >
                        <span class="fw-bold">Borda</span>
                        <div class="d-flex align-items-center justify-content-between border rounded py-1 px-2" id="dropdownBasic1" ngbDropdownToggle>
                          {{ newFlavor.implementations?.length ? newFlavor.implementations[0].name : 'Nenhum' }}
                        </div>
                        <div ngbDropdownMenu class="w-100" aria-labelledby="dropdownBasic1">
                          <div class="d-flex flex-column" style="max-height: 10rem; overflow-y: auto">
                            <button ngbDropdownItem class="p-1" (click)="newFlavor.implementations = []">
                              <!-- *ngIf="cartService.sizeIsAllowed(size, pizza)"  -->
                              Nenhum
                            </button>
                            <ng-container *ngFor="let implementation of pizzaProduct.implementations">
                              <button ngbDropdownItem class="p-1" (click)="newFlavor.implementations = [implementation]">
                                <!-- *ngIf="cartService.sizeIsAllowed(size, pizza)"  -->
                                {{ implementation.name }}
                              </button>
                            </ng-container>
                          </div>
                        </div>
                      </div>
                    </div>
                    <pdv-complements
                      *ngIf="context.profile.options.pizza.multipleComplements"
                      [(complements)]="newFlavor.complements"
                      [originalComplements]="pizzaProduct.complements"
                      [(cartPizza)]="cartPizza"
                    ></pdv-complements>
                    <!-- <button class="d-flex btn btn-link text-decoration-none"
                      (click)="openFlavorComponents(newFlavor)">+
                      {{ newFlavor.complements?.length ? "Editar" : "Adicionar" }} Complementos</button> -->
                  </div>
                </ng-template>
              </div>
            </ng-container>
            <button
              *ngIf="pizza.flavors.length < cartService.getSizeByCode(pizza)?.flavors[cartService.getSizeByCode(pizza)?.flavors.length - 1]"
              class="btn btn-link text-decoration-none px-3 py-2 rounded-0 rounded-top"
              style="width: auto; font-size: 0.875rem; padding: 0 0.5rem"
              (click)="addNewFlavor()"
            >
              Adicionar sabor
            </button>
          </nav>
          <div [ngbNavOutlet]="nav"></div>
          <div class="my-2"></div>
        </div>
        <pdv-complements
          *ngIf="!context.profile.options.pizza.multipleComplements"
          [(complements)]="pizza.complements"
          [originalComplements]="pizzaProduct.complements"
          [(cartPizza)]="cartPizza"
        ></pdv-complements>
      </div>
    </div>
  </mat-dialog-content>
  <mat-dialog-actions class="d-flex flex-row w-100">
    <div class="input-group w-100 mb-2">
      <textarea
        #obsInput
        (focus)="openKeyboard()"
        autofocus="false"
        placeholder="Observações"
        (blur)="closeKeyboard()"
        class="form-control"
      ></textarea>
      <span *ngIf="deviceWidth > 768" class="input-group-text">
        <fa-icon
          [icon]="faKeyboard"
          class="me-2"
          [ngStyle]="{ opacity: keyBoardIsEnable ? 1 : '0.5' }"
          style="border-radius: 0 6px 6px 0"
          (click)="toggleKeyboard()"
        ></fa-icon>
      </span>
    </div>
    <div class="d-flex align-items-center justify-content-between w-100">
      <div class="element-detail no-scroll-bar flex-column">
        <div class="d-flex align-items-center my-4">
          <div class="d-flex align-items-center ps-2 h-100">
            <fa-icon
              [icon]="faMinusCircle"
              [ngStyle]="{ opacity: (data.type === 'default' ? product : pizza).quantity > 1 ? 1 : 0.5 }"
              (click)="cartService.decreaseProduct(data.type === 'default' ? product : pizza); $event.stopPropagation()"
              style="color: var(--red); font-size: 1.25rem; cursor: pointer"
            >
            </fa-icon>
            <span class="mx-2" style="font-weight: bold">{{ (data.type === 'default' ? product : pizza).quantity }}</span>
            <fa-icon
              [icon]="faPlusCircle"
              (click)="cartService.increaseProduct(data.type === 'default' ? product : pizza); $event.stopPropagation()"
              style="color: var(--green); font-size: 1.25rem; cursor: pointer"
              *ngIf="
                data.type === 'pizza'
                  ? cartService.verifyCartFlavorAvailability(cartPizza, pizza, 'greaterOrEqual').availability &&
                    cartService.verifyPizzaProductAvailability(cartPizza, pizza, undefined, 'greaterOrEqual').availability &&
                    cartService.verifyProductAvailability(cart, 'pizza', 'greaterOrEqual')?.availability
                  : cartService.verifyProductAvailability(cart, data.type === 'default' ? product : pizza, 'greaterOrEqual')?.availability
              "
            >
            </fa-icon>
          </div>
        </div>
      </div>
      <button
        *ngIf="data.type === 'default'"
        [disabled]="!cartService.verifyProductAvailability(cart, data.type === 'default' ? product : pizza, 'greater')?.availability"
        class="btn btn-primary"
        style="font-size: 1rem"
        (click)="
          !product.status || !product.isAvaliable || cartService.denyAddItemToCart(productAllComplements())
            ? messageItemRequired(productAllComplements())
            : close()
        "
      >
        {{ 'Adicionar ' }}
        {{ cartService.itemValueWithComplements({ item: product, valueType: data.valueType, type: 'product', multiplyByQuantity: true }) | currency }}
      </button>
      <button
        *ngIf="data.type === 'pizza'"
        [disabled]="
          !cartService.getSizeByCode(pizza)?.flavors.includes(pizza.flavors.length) ||
          !cartService.verifyProductAvailability(cartPizza, pizza, 'greaterOrEqual').availability ||
          !cartService.verifyPizzaProductAvailability(cartPizza, pizza, undefined, 'greater').availability ||
          !cartService.verifyCartFlavorAvailability(cartPizza, pizza, 'greater').availability
        "
        class="btn btn-primary"
        style="font-size: 1rem"
        (click)="cartService.denyAddItemToCart(pizzaFlavorComplements()) ? messageItemRequired(pizzaFlavorComplements()) : close()"
      >
        {{
          !cartService.verifyCartFlavorAvailability(cart, pizza, 'greater')?.availability
            ? cartService.verifyCartFlavorAvailability(cart, pizza, 'greater')?.buttonMessage
            : 'Adicionar '
        }}{{ cartService.itemValueWithComplements({ item: pizza, valueType: data.valueType, type: 'pizza', multiplyByQuantity: true }) | currency }}
      </button>
    </div>
  </mat-dialog-actions>
</ng-container>
